name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  android-build:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      ANDROID_SDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      PATH: ${{ github.workspace }}/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin:${{ github.workspace }}/.buildozer/android/platform/android-sdk/platform-tools:${PATH}

    steps:
      # Clone repo using git to avoid tar extraction
      - name: Clone repository
        run: git clone ${{ github.repositoryUrl }} ${{ github.workspace }}

      # Show runner info for debugging
      - name: Debug runner
        run: |
          uname -a
          which python3
          python3 --version
          which tar || echo "tar not found"
          echo $PATH

      # Install Python environment
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # Create virtual environment
      - name: Create venv
        run: python3 -m venv venv

      - name: Activate venv and install Buildozer
        run: |
          source venv/bin/activate
          pip install --upgrade pip
          pip install buildozer Cython

      # Install Android SDK using Buildozer
      - name: Initialize Buildozer Android SDK
        run: |
          source venv/bin/activate
          buildozer android debug deploy run