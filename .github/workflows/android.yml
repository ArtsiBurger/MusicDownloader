name: Build MusicScripts APK

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROIDAPI: 31
      ANDROIDMINAPI: 21
      ANDROIDNDK: 27.3.13750724
      ANDROIDSDK: $HOME/.buildozer/android/platform/android-sdk
      PATH: $HOME/.buildozer/android/platform/apache-ant-1.9.4/bin:$PATH

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip git openjdk-17-jdk unzip zip wget
        pip install --upgrade pip
        pip install --user buildozer cython

    - name: Setup Android SDK
      run: |
        mkdir -p $ANDROIDSDK/cmdline-tools
        cd $ANDROIDSDK/cmdline-tools
        if [ ! -d latest ]; then
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip
          mv cmdline-tools latest
          rm cmdline-tools.zip
        fi

    - name: Accept SDK licenses
      run: |
        export ANDROID_HOME=$ANDROIDSDK
        SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -f "$SDKMANAGER" ]; then
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/cmdline-tools/bin/sdkmanager"
        fi
        chmod +x "$SDKMANAGER"
        yes | "$SDKMANAGER" --install "platform-tools" "build-tools;36.1.0" --licenses

    - name: Build APK with Buildozer
      run: |
        export PATH=$HOME/.local/bin:$PATH
        buildozer -v android debug